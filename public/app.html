<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - MoveQuote</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Crect width='32' height='32' rx='6' fill='%233b82f6'/%3E%3Cpath d='M8 14h16v12H8z' fill='white'/%3E%3Cpath d='M10 8h12v8H10z' fill='white' opacity='.8'/%3E%3Crect x='12' y='18' width='3' height='4' fill='%233b82f6'/%3E%3Crect x='17' y='18' width='3' height='4' fill='%233b82f6'/%3E%3C/svg%3E">
    <style>
        :root {
            --primary: #3b82f6;
            --primary-dark: #2563eb;
            --primary-light: #dbeafe;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
            --green-500: #10b981;
            --green-100: #d1fae5;
            --red-500: #ef4444;
            --red-100: #fee2e2;
            --yellow-500: #f59e0b;
            --yellow-100: #fef3c7;
            --blue-100: #dbeafe;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            color: var(--gray-800);
            background: var(--gray-50);
        }
        .app-container { display: flex; min-height: 100vh; }
        
        /* Sidebar */
        .sidebar {
            width: 240px;
            background: white;
            border-right: 1px solid var(--gray-200);
            padding: 1rem 0;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
        }
        .sidebar-header {
            padding: 0 1rem 1rem;
            border-bottom: 1px solid var(--gray-200);
            margin-bottom: 0.5rem;
        }
        .logo-sidebar {
            font-size: 1.25rem;
            font-weight: 800;
            color: var(--gray-900);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .logo-sidebar svg { width: 28px; height: 28px; }
        .sidebar-nav { list-style: none; }
        .nav-item {
            padding: 0.65rem 1rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.6rem;
            font-weight: 500;
            font-size: 0.9rem;
            color: var(--gray-700);
        }
        .nav-item:hover { background: var(--gray-50); color: var(--primary); }
        .nav-item.active { background: var(--primary-light); color: var(--primary); }
        .nav-section { padding: 0.5rem 1rem; font-size: 0.7rem; color: var(--gray-400); text-transform: uppercase; letter-spacing: 0.05em; margin-top: 0.5rem; }
        .sidebar-footer { margin-top: auto; padding: 1rem; border-top: 1px solid var(--gray-200); }
        
        /* Main Content */
        .main-content { margin-left: 240px; flex: 1; padding: 1.5rem 2rem; }
        .view-section { display: none; }
        .view-section.active { display: block; }
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .page-title { font-size: 1.5rem; font-weight: 700; color: var(--gray-900); }
        
        /* Buttons */
        .btn {
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-weight: 600;
            font-size: 0.875rem;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
        }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-secondary { background: white; color: var(--gray-700); border: 1px solid var(--gray-300); }
        .btn-secondary:hover { background: var(--gray-50); }
        .btn-sm { padding: 0.35rem 0.7rem; font-size: 0.8rem; }
        .btn-danger { background: var(--red-500); color: white; }
        
        /* Cards */
        .card {
            background: white;
            border-radius: 8px;
            border: 1px solid var(--gray-200);
            padding: 1.25rem;
            margin-bottom: 1rem;
        }
        .card-title { font-size: 0.9rem; font-weight: 600; color: var(--gray-700); margin-bottom: 0.75rem; }
        
        /* Stats Grid */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem; }
        .stat-card { background: white; border-radius: 8px; border: 1px solid var(--gray-200); padding: 1rem; }
        .stat-value { font-size: 1.75rem; font-weight: 700; color: var(--gray-900); }
        .stat-label { font-size: 0.8rem; color: var(--gray-500); margin-top: 0.25rem; }
        
        /* Tables */
        .data-table { width: 100%; border-collapse: collapse; }
        .data-table th, .data-table td { padding: 0.75rem; text-align: left; border-bottom: 1px solid var(--gray-200); }
        .data-table th { font-size: 0.75rem; font-weight: 600; color: var(--gray-500); text-transform: uppercase; letter-spacing: 0.03em; background: var(--gray-50); }
        .data-table tr:hover { background: var(--gray-50); }
        
        /* Status Badges */
        .badge {
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        .badge-draft { background: var(--gray-100); color: var(--gray-600); }
        .badge-sent { background: var(--blue-100); color: var(--primary); }
        .badge-approved { background: var(--green-100); color: var(--green-500); }
        .badge-completed { background: var(--green-100); color: var(--green-500); }
        .badge-changes_requested { background: var(--yellow-100); color: var(--yellow-500); }
        .badge-cancelled { background: var(--red-100); color: var(--red-500); }
        
        /* Forms */
        .form-group { margin-bottom: 1rem; }
        .form-label { display: block; font-size: 0.8rem; font-weight: 600; color: var(--gray-700); margin-bottom: 0.3rem; }
        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 0.5rem 0.75rem;
            border: 1px solid var(--gray-300);
            border-radius: 6px;
            font-size: 0.9rem;
            transition: border-color 0.2s;
        }
        .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: var(--primary); }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        .form-row-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; }
        .form-checkbox { display: flex; align-items: center; gap: 0.5rem; }
        .form-checkbox input { width: 16px; height: 16px; }
        
        /* Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-overlay.active { display: flex; }
        .modal {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 1.5rem;
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .modal-title { font-size: 1.1rem; font-weight: 700; }
        .modal-close { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--gray-400); }
        
        /* Calendar */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; background: var(--gray-200); border-radius: 8px; overflow: hidden; }
        .calendar-header { background: var(--gray-100); padding: 0.5rem; text-align: center; font-size: 0.75rem; font-weight: 600; color: var(--gray-600); }
        .calendar-day { background: white; min-height: 80px; padding: 0.25rem; }
        .calendar-day-number { font-size: 0.75rem; color: var(--gray-500); margin-bottom: 0.25rem; }
        .calendar-event { background: var(--primary-light); color: var(--primary-dark); padding: 0.15rem 0.3rem; font-size: 0.65rem; border-radius: 3px; margin-bottom: 2px; cursor: pointer; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        
        /* Toast */
        .toast {
            position: fixed;
            bottom: 1.5rem;
            right: 1.5rem;
            padding: 0.75rem 1.25rem;
            border-radius: 8px;
            font-weight: 500;
            z-index: 2000;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s;
        }
        .toast.show { transform: translateY(0); opacity: 1; }
        .toast.success { background: var(--green-500); color: white; }
        .toast.error { background: var(--red-500); color: white; }
        
        /* Empty State */
        .empty-state { text-align: center; padding: 2rem; color: var(--gray-500); }
        
        /* Tabs */
        .tabs { display: flex; gap: 0.5rem; margin-bottom: 1rem; border-bottom: 1px solid var(--gray-200); }
        .tab { padding: 0.5rem 1rem; cursor: pointer; font-weight: 500; color: var(--gray-500); border-bottom: 2px solid transparent; transition: all 0.2s; }
        .tab:hover { color: var(--gray-700); }
        .tab.active { color: var(--primary); border-bottom-color: var(--primary); }
        
        /* Checklist */
        .checklist-item { display: flex; align-items: center; gap: 0.5rem; padding: 0.4rem 0; border-bottom: 1px solid var(--gray-100); }
        .checklist-item input[type="checkbox"] { width: 18px; height: 18px; }
        .checklist-item.completed span { text-decoration: line-through; color: var(--gray-400); }
        .checklist-progress { height: 6px; background: var(--gray-200); border-radius: 3px; overflow: hidden; margin-bottom: 0.5rem; }
        .checklist-progress-bar { height: 100%; background: var(--green-500); transition: width 0.3s; }
        
        /* Loading */
        .loading { text-align: center; padding: 2rem; color: var(--gray-400); }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="logo-sidebar">
                    <svg viewBox="0 0 32 32"><rect width="32" height="32" rx="6" fill="#3b82f6"/><path d="M8 14h16v12H8z" fill="white"/><path d="M10 8h12v8H10z" fill="white" opacity=".8"/><rect x="12" y="18" width="3" height="4" fill="#3b82f6"/><rect x="17" y="18" width="3" height="4" fill="#3b82f6"/></svg>
                    MoveQuote
                </div>
            </div>
            <ul class="sidebar-nav">
                <li class="nav-item active" onclick="switchView('dashboard')">üìä Dashboard</li>
                <li class="nav-item" onclick="switchView('quotes')">üìù Quotes</li>
                <li class="nav-item" onclick="switchView('clients')">üë• Clients</li>
                <li class="nav-section">Operations</li>
                <li class="nav-item" onclick="switchView('schedule')">üìÖ Schedule</li>
                <li class="nav-item" onclick="switchView('team')">üöö Team</li>
                <li class="nav-item" onclick="switchView('checklists')">‚úÖ Checklists</li>
                <li class="nav-section">Account</li>
                <li class="nav-item" onclick="switchView('settings')">‚öôÔ∏è Settings</li>
                <li class="nav-item" onclick="logout()">üö™ Logout</li>
            </ul>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Dashboard -->
            <section id="view-dashboard" class="view-section active">
                <div class="page-header">
                    <h1 class="page-title">Dashboard</h1>
                    <button class="btn btn-primary" onclick="openNewQuoteModal()">+ New Quote</button>
                </div>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="stat-total">0</div>
                        <div class="stat-label">Total Quotes</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="stat-approved">0</div>
                        <div class="stat-label">Approved</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="stat-revenue">$0</div>
                        <div class="stat-label">Revenue</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="stat-upcoming">0</div>
                        <div class="stat-label">Upcoming Moves</div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-title">Recent Quotes</div>
                    <div id="recent-quotes"></div>
                </div>
            </section>

            <!-- Quotes -->
            <section id="view-quotes" class="view-section">
                <div class="page-header">
                    <h1 class="page-title">Quotes</h1>
                    <button class="btn btn-primary" onclick="openNewQuoteModal()">+ New Quote</button>
                </div>
                <div class="card">
                    <div id="quotes-list"></div>
                </div>
            </section>

            <!-- Clients -->
            <section id="view-clients" class="view-section">
                <div class="page-header">
                    <h1 class="page-title">Clients</h1>
                    <button class="btn btn-primary" onclick="openNewClientModal()">+ Add Client</button>
                </div>
                <div class="card">
                    <div id="clients-list"></div>
                </div>
            </section>

            <!-- Schedule -->
            <section id="view-schedule" class="view-section">
                <div class="page-header">
                    <h1 class="page-title">Schedule</h1>
                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                        <button class="btn btn-secondary" onclick="prevMonth()">‚Üê</button>
                        <span id="current-month" style="font-weight: 600; min-width: 150px; text-align: center;"></span>
                        <button class="btn btn-secondary" onclick="nextMonth()">‚Üí</button>
                    </div>
                </div>
                <div class="card">
                    <div id="calendar-container"></div>
                </div>
            </section>

            <!-- Team -->
            <section id="view-team" class="view-section">
                <div class="page-header">
                    <h1 class="page-title">Team</h1>
                    <button class="btn btn-primary" onclick="openNewTeamMemberModal()">+ Add Team Member</button>
                </div>
                <div class="card">
                    <div id="team-list"></div>
                </div>
            </section>

            <!-- Checklists -->
            <section id="view-checklists" class="view-section">
                <div class="page-header">
                    <h1 class="page-title">Checklists</h1>
                    <button class="btn btn-primary" onclick="openNewChecklistModal()">+ New Checklist</button>
                </div>
                <div class="card">
                    <div id="checklists-list"></div>
                </div>
            </section>

            <!-- Settings -->
            <section id="view-settings" class="view-section">
                <div class="page-header">
                    <h1 class="page-title">Settings</h1>
                </div>
                <div class="card">
                    <div class="card-title">Company Branding</div>
                    <form id="branding-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Business Name</label>
                                <input type="text" class="form-input" id="business-name">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Brand Color</label>
                                <input type="color" class="form-input" id="brand-color" value="#3b82f6">
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary">Save Branding</button>
                    </form>
                </div>
            </section>
        </main>
    </div>

    <!-- New Quote Modal -->
    <div class="modal-overlay" id="quote-modal">
        <div class="modal" style="max-width: 700px;">
            <div class="modal-header">
                <h2 class="modal-title">New Moving Quote</h2>
                <button class="modal-close" onclick="closeModal('quote-modal')">&times;</button>
            </div>
            <form id="quote-form">
                <div class="card-title">Client Information</div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Client Name *</label>
                        <input type="text" class="form-input" id="q-client-name" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-input" id="q-client-email">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Phone</label>
                    <input type="tel" class="form-input" id="q-client-phone">
                </div>
                
                <div class="card-title" style="margin-top: 1rem;">Move Details</div>
                <div class="form-group">
                    <label class="form-label">Origin Address *</label>
                    <input type="text" class="form-input" id="q-origin" required placeholder="123 Start St, City, State ZIP">
                </div>
                <div class="form-group">
                    <label class="form-label">Destination Address *</label>
                    <input type="text" class="form-input" id="q-destination" required placeholder="456 End Ave, City, State ZIP">
                </div>
                <div class="form-row-3">
                    <div class="form-group">
                        <label class="form-label">Move Type</label>
                        <select class="form-select" id="q-move-type">
                            <option value="local">Local</option>
                            <option value="long_distance">Long Distance</option>
                            <option value="commercial">Commercial</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Move Date</label>
                        <input type="date" class="form-input" id="q-move-date">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Move Time</label>
                        <input type="time" class="form-input" id="q-move-time" value="08:00">
                    </div>
                </div>
                <div class="form-row-3">
                    <div class="form-group">
                        <label class="form-label">Truck Size</label>
                        <select class="form-select" id="q-truck-size">
                            <option value="small">Small (10-12ft)</option>
                            <option value="medium" selected>Medium (16-17ft)</option>
                            <option value="large">Large (20-22ft)</option>
                            <option value="xlarge">XL (26ft)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label"># of Movers</label>
                        <input type="number" class="form-input" id="q-num-movers" value="2" min="1" max="10">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Estimated Hours</label>
                        <input type="number" class="form-input" id="q-hours" value="4" min="1" max="24" step="0.5">
                    </div>
                </div>
                
                <div class="card-title" style="margin-top: 1rem;">Add-ons</div>
                <div class="form-row">
                    <div class="form-checkbox">
                        <input type="checkbox" id="q-packing">
                        <label for="q-packing">Packing Service (+$75/hr)</label>
                    </div>
                    <div class="form-checkbox">
                        <input type="checkbox" id="q-storage">
                        <label for="q-storage">Storage Needed (+$150/mo)</label>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Insurance</label>
                    <select class="form-select" id="q-insurance">
                        <option value="basic">Basic (Included)</option>
                        <option value="standard">Standard (+$50)</option>
                        <option value="premium">Premium (+$150)</option>
                        <option value="full">Full Replacement (+$300)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Notes</label>
                    <textarea class="form-textarea" id="q-notes" rows="2" placeholder="Special items, access notes, etc."></textarea>
                </div>
                
                <div style="background: var(--gray-100); padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                    <div style="display: flex; justify-content: space-between; font-size: 1.25rem; font-weight: 700;">
                        <span>Estimated Total:</span>
                        <span id="q-total">$0</span>
                    </div>
                </div>
                
                <div style="display: flex; gap: 0.5rem; justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('quote-modal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Quote</button>
                </div>
            </form>
        </div>
    </div>

    <!-- New Client Modal -->
    <div class="modal-overlay" id="client-modal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Add Client</h2>
                <button class="modal-close" onclick="closeModal('client-modal')">&times;</button>
            </div>
            <form id="client-form">
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Name *</label>
                        <input type="text" class="form-input" id="c-name" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-input" id="c-email">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Phone</label>
                    <input type="tel" class="form-input" id="c-phone">
                </div>
                <div class="form-group">
                    <label class="form-label">Origin Address</label>
                    <input type="text" class="form-input" id="c-origin">
                </div>
                <div class="form-group">
                    <label class="form-label">Destination Address</label>
                    <input type="text" class="form-input" id="c-destination">
                </div>
                <div class="form-group">
                    <label class="form-label">Move Date</label>
                    <input type="date" class="form-input" id="c-move-date">
                </div>
                <div class="form-group">
                    <label class="form-label">Notes</label>
                    <textarea class="form-textarea" id="c-notes" rows="2"></textarea>
                </div>
                <div style="display: flex; gap: 0.5rem; justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('client-modal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Client</button>
                </div>
            </form>
        </div>
    </div>

    <!-- New Team Member Modal -->
    <div class="modal-overlay" id="team-modal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Add Team Member</h2>
                <button class="modal-close" onclick="closeModal('team-modal')">&times;</button>
            </div>
            <form id="team-form">
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Name *</label>
                        <input type="text" class="form-input" id="t-name" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Role</label>
                        <select class="form-select" id="t-role">
                            <option value="mover">Mover</option>
                            <option value="driver">Driver</option>
                            <option value="lead">Team Lead</option>
                            <option value="packer">Packer</option>
                            <option value="specialist">Specialist</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-input" id="t-email">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Phone</label>
                        <input type="tel" class="form-input" id="t-phone">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Hourly Rate ($)</label>
                    <input type="number" class="form-input" id="t-rate" value="25" step="0.50">
                </div>
                <div style="display: flex; gap: 0.5rem; justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('team-modal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Team Member</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <script>
        // ============================================
        // CONFIG
        // ============================================
        const API_URL = window.location.hostname === 'localhost' 
            ? 'http://localhost:3000' 
            : 'https://movequote-api.up.railway.app';
        
        let allQuotes = [];
        let allClients = [];
        let allTeam = [];
        let allChecklists = [];
        let currentMonth = new Date();
        let scheduleData = [];

        // ============================================
        // INIT
        // ============================================
        async function init() {
            const token = localStorage.getItem('mq_token');
            if (!token) {
                window.location.href = 'auth.html';
                return;
            }
            
            try {
                await Promise.all([
                    loadQuotes(),
                    loadClients(),
                    loadTeam(),
                    loadChecklists(),
                    loadSchedule()
                ]);
            } catch (err) {
                console.error('Init error:', err);
            }
        }

        // ============================================
        // API HELPERS
        // ============================================
        function getHeaders() {
            return {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${localStorage.getItem('mq_token')}`
            };
        }

        async function apiGet(endpoint) {
            const res = await fetch(`${API_URL}${endpoint}`, { headers: getHeaders() });
            if (!res.ok) throw new Error(await res.text());
            return res.json();
        }

        async function apiPost(endpoint, data) {
            const res = await fetch(`${API_URL}${endpoint}`, {
                method: 'POST',
                headers: getHeaders(),
                body: JSON.stringify(data)
            });
            if (!res.ok) throw new Error(await res.text());
            return res.json();
        }

        async function apiDelete(endpoint) {
            const res = await fetch(`${API_URL}${endpoint}`, {
                method: 'DELETE',
                headers: getHeaders()
            });
            if (!res.ok) throw new Error(await res.text());
            return res.json();
        }

        // ============================================
        // QUOTES
        // ============================================
        async function loadQuotes() {
            try {
                const data = await apiGet('/api/quotes');
                allQuotes = data.quotes || [];
                renderQuotes();
                updateStats();
            } catch (err) {
                console.error('Load quotes error:', err);
            }
        }

        function renderQuotes() {
            const container = document.getElementById('quotes-list');
            const recentContainer = document.getElementById('recent-quotes');
            
            if (allQuotes.length === 0) {
                container.innerHTML = '<div class="empty-state">No quotes yet. Create your first moving quote!</div>';
                recentContainer.innerHTML = '<div class="empty-state">No quotes yet.</div>';
                return;
            }

            const tableHtml = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Client</th>
                            <th>Route</th>
                            <th>Move Date</th>
                            <th>Amount</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${allQuotes.map(q => `
                            <tr>
                                <td>
                                    <strong>${q.clientName || 'N/A'}</strong><br>
                                    <small style="color: var(--gray-500)">${q.clientEmail || ''}</small>
                                </td>
                                <td>
                                    <small>${truncate(q.originAddress, 25) || 'N/A'}</small><br>
                                    <small>‚Üí ${truncate(q.destinationAddress, 25) || 'N/A'}</small>
                                </td>
                                <td>${q.moveDate ? new Date(q.moveDate).toLocaleDateString() : 'TBD'}</td>
                                <td><strong>$${(q.totalPrice || 0).toLocaleString()}</strong></td>
                                <td><span class="badge badge-${q.status || 'draft'}">${q.status || 'Draft'}</span></td>
                                <td>
                                    <button class="btn btn-sm btn-secondary" onclick="shareQuote('${q.id}')">Share</button>
                                    <button class="btn btn-sm btn-secondary" onclick="deleteQuote('${q.id}')">üóë</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            container.innerHTML = tableHtml;
            
            // Recent quotes (last 5)
            const recent = allQuotes.slice(0, 5);
            recentContainer.innerHTML = `
                <table class="data-table">
                    <thead>
                        <tr><th>Client</th><th>Route</th><th>Amount</th><th>Status</th></tr>
                    </thead>
                    <tbody>
                        ${recent.map(q => `
                            <tr>
                                <td><strong>${q.clientName || 'N/A'}</strong></td>
                                <td><small>${truncate(q.originAddress, 20)} ‚Üí ${truncate(q.destinationAddress, 20)}</small></td>
                                <td><strong>$${(q.totalPrice || 0).toLocaleString()}</strong></td>
                                <td><span class="badge badge-${q.status || 'draft'}">${q.status || 'Draft'}</span></td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        function updateStats() {
            const approved = allQuotes.filter(q => ['approved', 'completed'].includes(q.status));
            const revenue = approved.reduce((sum, q) => sum + (q.totalPrice || 0), 0);
            const upcoming = allQuotes.filter(q => {
                if (!q.moveDate) return false;
                return new Date(q.moveDate) >= new Date();
            });

            document.getElementById('stat-total').textContent = allQuotes.length;
            document.getElementById('stat-approved').textContent = approved.length;
            document.getElementById('stat-revenue').textContent = '$' + revenue.toLocaleString();
            document.getElementById('stat-upcoming').textContent = upcoming.length;
        }

        function openNewQuoteModal() {
            document.getElementById('quote-form').reset();
            document.getElementById('q-total').textContent = '$0';
            openModal('quote-modal');
            calculateQuoteTotal();
        }

        function calculateQuoteTotal() {
            const moveType = document.getElementById('q-move-type').value;
            const truckSize = document.getElementById('q-truck-size').value;
            const numMovers = parseInt(document.getElementById('q-num-movers').value) || 2;
            const hours = parseFloat(document.getElementById('q-hours').value) || 4;
            const packing = document.getElementById('q-packing').checked;
            const storage = document.getElementById('q-storage').checked;
            const insurance = document.getElementById('q-insurance').value;

            const hourlyRates = { local: 120, long_distance: 150, commercial: 180 };
            const truckMultipliers = { small: 0.8, medium: 1.0, large: 1.2, xlarge: 1.5 };
            const insurancePrices = { basic: 0, standard: 50, premium: 150, full: 300 };

            let total = (hourlyRates[moveType] || 120) * (truckMultipliers[truckSize] || 1) * numMovers * hours;
            if (packing) total += hours * 75;
            if (storage) total += 150;
            total += insurancePrices[insurance] || 0;

            document.getElementById('q-total').textContent = '$' + Math.round(total).toLocaleString();
        }

        // Auto-calculate on form changes
        document.querySelectorAll('#quote-form select, #quote-form input').forEach(el => {
            el.addEventListener('change', calculateQuoteTotal);
            el.addEventListener('input', calculateQuoteTotal);
        });

        document.getElementById('quote-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = {
                clientName: document.getElementById('q-client-name').value,
                clientEmail: document.getElementById('q-client-email').value,
                clientPhone: document.getElementById('q-client-phone').value,
                originAddress: document.getElementById('q-origin').value,
                destinationAddress: document.getElementById('q-destination').value,
                moveType: document.getElementById('q-move-type').value,
                moveDate: document.getElementById('q-move-date').value || null,
                moveTime: document.getElementById('q-move-time').value || null,
                truckSize: document.getElementById('q-truck-size').value,
                numMovers: parseInt(document.getElementById('q-num-movers').value),
                estimatedHours: parseFloat(document.getElementById('q-hours').value),
                packingService: document.getElementById('q-packing').checked,
                storageNeeded: document.getElementById('q-storage').checked,
                insuranceType: document.getElementById('q-insurance').value,
                notes: document.getElementById('q-notes').value
            };

            // Calculate prices
            const hourlyRates = { local: 120, long_distance: 150, commercial: 180 };
            const truckMultipliers = { small: 0.8, medium: 1.0, large: 1.2, xlarge: 1.5 };
            const insurancePrices = { basic: 0, standard: 50, premium: 150, full: 300 };

            formData.hourlyRate = (hourlyRates[formData.moveType] || 120) * (truckMultipliers[formData.truckSize] || 1);
            formData.basePrice = formData.hourlyRate * formData.numMovers * formData.estimatedHours;
            formData.packingPrice = formData.packingService ? formData.estimatedHours * 75 : 0;
            formData.storagePrice = formData.storageNeeded ? 150 : 0;
            formData.insurancePrice = insurancePrices[formData.insuranceType] || 0;
            formData.addonsPrice = formData.packingPrice + formData.storagePrice + formData.insurancePrice;
            formData.totalPrice = Math.round(formData.basePrice + formData.addonsPrice);

            try {
                await apiPost('/api/quotes', formData);
                showToast('Quote created!', 'success');
                closeModal('quote-modal');
                await loadQuotes();
            } catch (err) {
                showToast('Failed to create quote', 'error');
            }
        });

        async function shareQuote(id) {
            try {
                const data = await apiPost(`/api/quotes/${id}/share`, { expiresInDays: 7 });
                await navigator.clipboard.writeText(data.shareUrl);
                showToast('Share link copied to clipboard!', 'success');
            } catch (err) {
                showToast('Failed to generate share link', 'error');
            }
        }

        async function deleteQuote(id) {
            if (!confirm('Delete this quote?')) return;
            try {
                await apiDelete(`/api/quotes/${id}`);
                showToast('Quote deleted', 'success');
                await loadQuotes();
            } catch (err) {
                showToast('Failed to delete quote', 'error');
            }
        }

        // ============================================
        // CLIENTS
        // ============================================
        async function loadClients() {
            try {
                const data = await apiGet('/api/clients');
                allClients = data.clients || [];
                renderClients();
            } catch (err) {
                console.error('Load clients error:', err);
            }
        }

        function renderClients() {
            const container = document.getElementById('clients-list');
            if (allClients.length === 0) {
                container.innerHTML = '<div class="empty-state">No clients yet. Add your first client!</div>';
                return;
            }

            container.innerHTML = `
                <table class="data-table">
                    <thead>
                        <tr><th>Name</th><th>Contact</th><th>Origin</th><th>Destination</th><th>Move Date</th><th>Actions</th></tr>
                    </thead>
                    <tbody>
                        ${allClients.map(c => `
                            <tr>
                                <td><strong>${c.name}</strong></td>
                                <td>
                                    <small>${c.email || ''}</small><br>
                                    <small>${c.phone || ''}</small>
                                </td>
                                <td><small>${truncate(c.originAddress, 25) || '-'}</small></td>
                                <td><small>${truncate(c.destinationAddress, 25) || '-'}</small></td>
                                <td>${c.moveDate ? new Date(c.moveDate).toLocaleDateString() : '-'}</td>
                                <td>
                                    <button class="btn btn-sm btn-primary" onclick="createQuoteFromClient('${c.id}')">Quote</button>
                                    <button class="btn btn-sm btn-secondary" onclick="deleteClient('${c.id}')">üóë</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        function openNewClientModal() {
            document.getElementById('client-form').reset();
            openModal('client-modal');
        }

        document.getElementById('client-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = {
                name: document.getElementById('c-name').value,
                email: document.getElementById('c-email').value,
                phone: document.getElementById('c-phone').value,
                originAddress: document.getElementById('c-origin').value,
                destinationAddress: document.getElementById('c-destination').value,
                moveDate: document.getElementById('c-move-date').value || null,
                notes: document.getElementById('c-notes').value
            };
            try {
                await apiPost('/api/clients', formData);
                showToast('Client added!', 'success');
                closeModal('client-modal');
                await loadClients();
            } catch (err) {
                showToast('Failed to add client', 'error');
            }
        });

        async function createQuoteFromClient(clientId) {
            try {
                const data = await apiPost(`/api/clients/${clientId}/quote`, {});
                showToast('Quote created from client!', 'success');
                await loadQuotes();
                switchView('quotes');
            } catch (err) {
                showToast('Failed to create quote', 'error');
            }
        }

        async function deleteClient(id) {
            if (!confirm('Delete this client?')) return;
            try {
                await apiDelete(`/api/clients/${id}`);
                showToast('Client deleted', 'success');
                await loadClients();
            } catch (err) {
                showToast('Failed to delete client', 'error');
            }
        }

        // ============================================
        // TEAM
        // ============================================
        async function loadTeam() {
            try {
                const data = await apiGet('/api/team');
                allTeam = data.team || [];
                renderTeam();
            } catch (err) {
                console.error('Load team error:', err);
            }
        }

        function renderTeam() {
            const container = document.getElementById('team-list');
            if (allTeam.length === 0) {
                container.innerHTML = '<div class="empty-state">No team members yet. Add your crew!</div>';
                return;
            }

            container.innerHTML = `
                <table class="data-table">
                    <thead>
                        <tr><th>Name</th><th>Role</th><th>Contact</th><th>Rate</th><th>Jobs</th><th>Actions</th></tr>
                    </thead>
                    <tbody>
                        ${allTeam.map(t => `
                            <tr style="${!t.isActive ? 'opacity: 0.5;' : ''}">
                                <td><strong>${t.name}</strong></td>
                                <td><span class="badge badge-draft">${t.role}</span></td>
                                <td>
                                    <small>${t.email || ''}</small><br>
                                    <small>${t.phone || ''}</small>
                                </td>
                                <td>$${t.hourlyRate || 0}/hr</td>
                                <td>${t.stats?.totalJobs || 0} jobs</td>
                                <td>
                                    <button class="btn btn-sm btn-secondary" onclick="deleteTeamMember('${t.id}')">üóë</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        function openNewTeamMemberModal() {
            document.getElementById('team-form').reset();
            openModal('team-modal');
        }

        document.getElementById('team-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = {
                name: document.getElementById('t-name').value,
                role: document.getElementById('t-role').value,
                email: document.getElementById('t-email').value,
                phone: document.getElementById('t-phone').value,
                hourlyRate: parseFloat(document.getElementById('t-rate').value)
            };
            try {
                await apiPost('/api/team', formData);
                showToast('Team member added!', 'success');
                closeModal('team-modal');
                await loadTeam();
            } catch (err) {
                showToast('Failed to add team member', 'error');
            }
        });

        async function deleteTeamMember(id) {
            if (!confirm('Delete this team member?')) return;
            try {
                await apiDelete(`/api/team/${id}`);
                showToast('Team member deleted', 'success');
                await loadTeam();
            } catch (err) {
                showToast('Failed to delete - may have active assignments', 'error');
            }
        }

        // ============================================
        // SCHEDULE
        // ============================================
        async function loadSchedule() {
            const year = currentMonth.getFullYear();
            const month = currentMonth.getMonth();
            const start = new Date(year, month, 1).toISOString().split('T')[0];
            const end = new Date(year, month + 1, 0).toISOString().split('T')[0];
            
            try {
                const data = await apiGet(`/api/schedule?start=${start}&end=${end}`);
                scheduleData = data.schedule || [];
                renderCalendar();
            } catch (err) {
                console.error('Load schedule error:', err);
                renderCalendar();
            }
        }

        function renderCalendar() {
            const year = currentMonth.getFullYear();
            const month = currentMonth.getMonth();
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
            
            document.getElementById('current-month').textContent = `${monthNames[month]} ${year}`;

            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];

            let html = '<div class="calendar-grid">';
            
            // Headers
            dayNames.forEach(d => { html += `<div class="calendar-header">${d}</div>`; });
            
            // Empty cells before first day
            for (let i = 0; i < firstDay; i++) {
                html += '<div class="calendar-day" style="background: var(--gray-50);"></div>';
            }
            
            // Days
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const dayEvents = scheduleData.filter(e => e.date === dateStr || e.moveDate === dateStr);
                
                html += `<div class="calendar-day">
                    <div class="calendar-day-number">${day}</div>
                    ${dayEvents.slice(0, 3).map(e => `
                        <div class="calendar-event" title="${e.clientName}: ${e.originAddress} ‚Üí ${e.destinationAddress}">
                            ${e.startTime ? e.startTime.substring(0, 5) : ''} ${e.title || e.clientName}
                        </div>
                    `).join('')}
                    ${dayEvents.length > 3 ? `<div style="font-size: 0.65rem; color: var(--gray-500);">+${dayEvents.length - 3} more</div>` : ''}
                </div>`;
            }
            
            html += '</div>';
            document.getElementById('calendar-container').innerHTML = html;
        }

        function prevMonth() {
            currentMonth.setMonth(currentMonth.getMonth() - 1);
            loadSchedule();
        }

        function nextMonth() {
            currentMonth.setMonth(currentMonth.getMonth() + 1);
            loadSchedule();
        }

        // ============================================
        // CHECKLISTS
        // ============================================
        async function loadChecklists() {
            try {
                const data = await apiGet('/api/checklists');
                allChecklists = data.checklists || [];
                renderChecklists();
            } catch (err) {
                console.error('Load checklists error:', err);
            }
        }

        function renderChecklists() {
            const container = document.getElementById('checklists-list');
            if (allChecklists.length === 0) {
                container.innerHTML = '<div class="empty-state">No checklists yet.</div>';
                return;
            }

            container.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1rem;">
                    ${allChecklists.map(c => `
                        <div class="card" style="margin-bottom: 0;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                <strong>${c.name}</strong>
                                ${c.isDefault ? '<span class="badge badge-approved">Default</span>' : ''}
                            </div>
                            <div style="font-size: 0.8rem; color: var(--gray-500); margin-bottom: 0.5rem;">
                                ${c.type} ‚Ä¢ ${(c.items || []).length} items
                            </div>
                            <div style="font-size: 0.8rem;">
                                ${(c.items || []).slice(0, 3).map(item => `‚Ä¢ ${item.text}`).join('<br>')}
                                ${(c.items || []).length > 3 ? `<br><em>+${c.items.length - 3} more...</em>` : ''}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function openNewChecklistModal() {
            showToast('Create custom checklists from the API or duplicate defaults', 'success');
        }

        // ============================================
        // UI HELPERS
        // ============================================
        function switchView(viewName) {
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            event.target.closest('.nav-item')?.classList.add('active');
            
            document.querySelectorAll('.view-section').forEach(s => s.classList.remove('active'));
            document.getElementById('view-' + viewName)?.classList.add('active');
            
            // Refresh data when switching views
            if (viewName === 'schedule') loadSchedule();
        }

        function openModal(id) {
            document.getElementById(id).classList.add('active');
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('active');
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast ' + type + ' show';
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        function truncate(str, len) {
            if (!str) return '';
            return str.length > len ? str.substring(0, len) + '...' : str;
        }

        function logout() {
            localStorage.removeItem('mq_token');
            localStorage.removeItem('mq_user');
            window.location.href = 'auth.html';
        }

        // Close modals on overlay click
        document.querySelectorAll('.modal-overlay').forEach(overlay => {
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) overlay.classList.remove('active');
            });
        });

        // ============================================
        // START
        // ============================================
        init();
    </script>
</body>
</html>
